<users>
{
doc('DataFileName")/users/*
}
</users>

<users>
{
for $e in doc('AuditTrail.xml')/audit_trail/event
where $e/type = "submitForBatch" and not ($e[processed])
return doc($e/metadata/file_name/text())/users/*
}
</users>

let $e:=<event><time>ttt</time><type>initiateXBatchJob</type><queue_id>qqq</queue_id></event>
return insert node $e as first into /audit_trail
							
for $x in doc("books.xml")/bookstore/book
return	if ($x/@category="CHILDREN")
then <child>{data($x/title)}</child>
else <adult>{data($x/title)}</adult>

for $prod at $p in (1 to 10)
return $p

let $cd := current-date()
let $fd := $cd - xs:dayTimeDuration("P28D")
return
<users>
	{
	for $m in doc('/Members.xml')/members/member
	return
		<user>
		{
		for $u in doc('/xPressionHelper/FromHIP')/users/user
		where $u/external_id = $m/badge_number
		return
			<d>
			{
			for $prod at $p in (1 to 10)
			let $d := $fd + xs:dayTimeDuration(concat("P", $p, "D"))
			return
				<dd>{$d}</dd>
			}
			</d>
		}
		</user>
	}
</users>

************************************************************************************************************************
let $current_day := xs:date("2015-02-10")
let $first_day := $current_day - xs:dayTimeDuration("P28D")
return
<users>
{
for $m in doc('/Members.xml')/members/member
return
		<user>
			<badge_number>{$m/badge_number/text()}</badge_number>
			<index_history>
				<items>
	{
	for $day_offset in (1 to 28)
	let $current_date := $first_day + xs:dayTimeDuration(concat("P", $day_offset, "D"))
	return
					<item>
						<day>{$day_offset}</day>
						<date>{$current_date}</date>
						<value>
		{						
		let $current_date_extract := xs:date(doc('/xPressionHelper/FromHIP/')/users/user[./external_id = $m/badge_number and xs:date(./index_history/last_value_date/text()) = xs:date($current_date)]/index_history/last_value_date/text())
		let $current_date_day := xs:date($current_date)
		let $current_value := doc('/xPressionHelper/FromHIP/')/users/user[./external_id = $m/badge_number and xs:date(./index_history/last_value_date/text()) = xs:date($current_date)]/index_history/values/value[7]/text()
		return 
		if ($current_date_day=$current_date_extract)
		then $current_value
		else 0
		}
						</value>
					</item>
	}
				</items>
			</index_history>
		</user>
}
</users>

*************************************************************************************************************************
let $current_day := xs:date("2015-02-10")
let $first_day := $current_day - xs:dayTimeDuration("P28D")
let $source := doc('/xPressionHelper/FromHIP/')
return
<users>
{
for $m in doc('/Members.xml')/members/member
let $u := $source/users/user[./external_id = $m/badge_number][1]
return
		<user>
			<badge_number>{$m/badge_number/text()}</badge_number>
			<username>{$u/username/text()}</username>
			<email>{$u/email/text()}</email>
			<gender>{$u/gender/text()}</gender>
			<index_history>
				<update_date>{$current_day}</update_date>
				<first_date>{$first_day}</first_date>
				<items>
	{
	for $day_offset in (1 to 28)
	let $current_date := $first_day + xs:dayTimeDuration(concat("P", $day_offset, "D"))
	return
					<item>
						<day_offset>{$day_offset}</day_offset>
						<date>{$current_date}</date>
						<value>
		{						
		let $current_date_extract := xs:date($source/users/user[
				./external_id = $m/badge_number
				and
				xs:date(./index_history/last_value_date/text()) = xs:date($current_date)
			]/index_history/last_value_date/text())
		let $current_date_day := xs:date($current_date)
		let $current_value := $source/users/user[
				./external_id = $m/badge_number
				and
				xs:date(./index_history/last_value_date/text()) = xs:date($current_date)
			]/index_history/values/value[7]/text()
		return 
			if ($current_date_day=$current_date_extract)
			then $current_value
			else 0
		}
						</value>
					</item>
	}
				</items>
			</index_history>
		</user>
}
</users>